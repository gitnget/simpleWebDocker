<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/attgrid.css" />
    <script src="/js/auth.js"></script>
  </head>
  <body>
    <!--#include virtual="/header.html" -->

    <main class="container my-4">
      <div class="d-flex flex-column align-items-center">
        <h4>Student's Attendance Report</h4>
        <div class="d-flex align-items-center gap-2 mb-3">
          <label for="stuid" class="form-label mb-0" style="min-width: 80px">Search ID:</label>
          <input type="text" class="form-control" id="stuid" name="stuid" value="123459" placeholder="Scan or enter student ID" autofocus required />
          <button id="searchBtn" class="btn btn-primary">Search</button>
        </div>
      </div>

      <div id="error" class="error" style="color: red"></div>

      <!-- Student info result -->
      <div id="studentInfo" class="d-flex justify-content-center">
        <div class="student-card" id="studentCard">
          <div class="card-header-strip" id="schoolname">Sekolah Menengah Air Itam</div>

          <div class="card-content">
            <div class="card-top">
              <div class="student-photo"></div>
              <div class="student-name-id">
                <div class="student-name" id="studentname"></div>
                <div class="student-id" id="studentid"></div>
              </div>
            </div>

            <div class="student-info-row">
              <div id="curyear"></div>
              <div id="curform"></div>
              <div id="curclass"></div>
            </div>
          </div>
        </div>
      </div>

      <br />

      <!-- Chart area -->
      <div class="grid-wrap">
        <div id="grid-container" class="grid-container">
          <div class="heatmap">
            <div id="months" class="months"></div>
            <div class="day-labels">
              <div>Mon</div>
              <div></div>
              <div>Wed</div>
              <div></div>
              <div>Fri</div>
              <div></div>
              <div>Sun</div>
            </div>
            <div id="grid" class="grid"></div>
          </div>

          <div class="legend">
            <span class="swatch present"></span> <span>Present</span> <span class="swatch late"></span> <span>Late</span>
            <span class="swatch absent"></span><span>Absent</span> | <span class="swatch weekend"></span><span>Weekend</span>
            <span class="swatch out"></span> <span>Out-of-range</span>
          </div>
        </div>
      </div>

      <br />

      <!-- Attendance Trend Text Div -->
      <div id="summary" class="summary-box"></div>

      <!-- Data Table -->
      <div id="resultsTable"></div>
    </main>

    <!-- tooltip to sit outside main to work -->
    <div id="tooltip" class="tooltip"></div>

    <!--#include virtual="/footer.html" -->

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="/js/attendancetable.js"></script>
    <script src="/js/script.js"></script>
    <script>
      async function initCalendar() {
        try {
          const response = await fetch("daily1234.json");
          const records = await response.json();

          const attendance = Object.create(null);
          for (const r of records) attendance[r.attendancedate] = r.status;

          const pad = (n) => String(n).padStart(2, "0");
          const ymd = (d) => `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
          const monday = (d) => {
            const x = new Date(d);
            const day = (x.getDay() + 6) % 7;
            x.setDate(x.getDate() - day);
            x.setHours(0, 0, 0, 0);
            return x;
          };
          const sunday = (d) => {
            const x = new Date(d);
            const day = (x.getDay() + 6) % 7;
            x.setDate(x.getDate() + (6 - day));
            x.setHours(0, 0, 0, 0);
            return x;
          };

          const yearStart = new Date(2025, 0, 1);
          const yearEnd = new Date(2025, 11, 31);
          const gridStart = monday(yearStart);
          const gridEnd = sunday(yearEnd);
          const MS_DAY = 24 * 60 * 60 * 1000;
          const totalDays = Math.round((gridEnd - gridStart) / MS_DAY) + 1;
          const totalCols = Math.ceil(totalDays / 7);

          // --- Month Labels ---
          const months = document.getElementById("months");
          months.style.gridTemplateColumns = `repeat(${totalCols}, var(--cell))`;

          const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
          for (let m = 0; m < 12; m++) {
            const first = new Date(2025, m, 1);
            if (first < gridStart || first > gridEnd) continue;
            const colStart = Math.floor((monday(first) - gridStart) / MS_DAY / 7) + 1;
            const next = new Date(2025, m + 1, 1);
            const colEnd = Math.floor((monday(next) - gridStart) / MS_DAY / 7) + 1;
            const label = document.createElement("div");
            label.textContent = monthNames[m];
            label.style.gridColumn = `${colStart} / ${colEnd}`;
            months.appendChild(label);
          }

          // --- Grid ---
          const grid = document.getElementById("grid");
          grid.style.gridTemplateColumns = `repeat(${totalCols}, var(--cell))`;

          const tooltip = document.getElementById("tooltip");

          for (let i = 0; i < totalDays; i++) {
            const d = new Date(gridStart);
            d.setDate(d.getDate() + i);
            const inRange = d >= yearStart && d <= yearEnd;
            const rowIdx = ((d.getDay() + 6) % 7) + 1;
            const colIdx = Math.floor(i / 7) + 1;

            const cell = document.createElement("div");
            cell.className = "day";
            cell.style.gridRow = rowIdx;
            cell.style.gridColumn = colIdx;

            const dateStr = ymd(d);
            const status = attendance[dateStr];

            if (!inRange) cell.classList.add("out");
            else if (d.getDay() === 0 || d.getDay() === 6) cell.classList.add("weekend");
            else if (status === "PRESENT") cell.classList.add("present");
            else if (status === "LATE") cell.classList.add("late");
            else if (status === "ABSENT") cell.classList.add("absent");

            // Tooltip
            const pretty = !inRange ? "Out of range" : status || "No Data";
            cell.addEventListener("mouseenter", () => {
              tooltip.style.display = "block";
              tooltip.textContent = `${dateStr}: ${pretty}`;
            });
            cell.addEventListener("mousemove", (e) => {
              tooltip.style.left = e.pageX + 12 + "px";
              tooltip.style.top = e.pageY + 12 + "px";
            });
            cell.addEventListener("mouseleave", () => (tooltip.style.display = "none"));

            grid.appendChild(cell);
          }
        } catch (err) {
          console.error("Error loading JSON:", err);
        }
      }
      initCalendar();
    </script>
    <script>
      // Elements
      const API_BASE = "https://fastapi-service-101554626321.asia-southeast1.run.app";
      const studentidInput = document.getElementById("stuid");
      const searchBtn = document.getElementById("searchBtn");
      const studentCard = document.getElementById("studentCard");
      // const chartDiv = document.getElementById("chart-container");
      const gridDiv = document.getElementById("grid-container");
      const summaryDiv = document.getElementById("summary");

      async function fetchStudent() {
        const barcode = studentidInput.value.trim();
        if (!barcode) return;

        // Hide UI elements while loading
        studentCard.style.display = "none";
        //chartDiv.style.display = "none";
        gridDiv.style.display = "none";
        summaryDiv.style.display = "none";

        try {
          const response = await fetch(`${API_BASE}/getstubystuid?stuid=${encodeURIComponent(barcode)}`);

          // alert(`${API_BASE}/getstubystuid?stuid=${encodeURIComponent(barcode)}`);

          if (!response.ok) {
            throw new Error("Student not found");
          }
          const data = await response.json();

          // Fill student card
          document.getElementById("studentname").textContent = data.name || "N/A";
          document.getElementById("studentid").textContent = `ID: ${data.stuid || "N/A"}`;
          document.getElementById("curyear").innerHTML = `<span>Year:</span> ${data.year || "N/A"}`;
          document.getElementById("curform").innerHTML = `<span>Form:</span> ${data.form || "N/A"}`;
          document.getElementById("curclass").innerHTML = `<span>Class:</span> ${data.class || "N/A"}`;

          if (data.photoURL) {
            document.querySelector(".student-photo").style.backgroundImage = `url(${data.photoURL})`;
          } else {
            document.querySelector(".student-photo").style.backgroundImage = "none";
          }

          // Show UI elements
          studentCard.style.display = "block";
          //chartDiv.style.display = "block";
          gridDiv.style.display = "grid";
          summaryDiv.style.display = "block";

          // Call your chart function
          if (typeof loadChart === "function") loadChart();
        } catch (err) {
          alert(err.message);
          studentCard.style.display = "none";
          //chartDiv.style.display = "none";
          summaryDiv.style.display = "none";
          console.error(err);
        }

        // clear the student ID textbox
        // studentidInput.value = "";
      }

      // Trigger fetch on Enter key
      studentidInput.addEventListener("keypress", (event) => {
        if (event.key === "Enter") fetchStudent();
      });

      // Trigger fetch on Search button click
      searchBtn.addEventListener("click", fetchStudent);
    </script>
  </body>
</html>
